generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum Channel {
  whatsapp
  messenger
  instagram
  tiktok
}

enum ContactStatus {
  new
  contacted
  qualified
  unqualified
  demo
  won
}

enum DealStatus {
  Won
  Lost
  InProgress
}

enum EmailFolder {
  inbox
  sent
  drafts
  trash
}

enum MessageSender {
  user
  contact
}

enum IntegrationStatus {
  connected
  disconnected
}

enum ServiceStatusType {
  operational
  degraded
  outage
}

enum SupportMessageSender {
  user
  support
}

enum UserRole {
  admin
  commercial
}

// Customer model (tenant/organization)
model Customer {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  contacts      Contact[]
  conversations Conversation[]
  integrations  Integration[]
  businessInfo  BusinessInfo?
  emails        Email[]
}

// User model (belongs to a customer/tenant)
model User {
  id         String   @id @default(uuid())
  email      String   @unique
  password   String
  name       String
  avatarUrl  String?
  role       UserRole @default(admin)
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  messages        Message[]
  supportMessages SupportMessage[]
  sentEmails      Email[]          @relation("SentEmails")
  integrations    Integration[]

  @@index([customerId])
}

// Contact model (previously Customer - people/leads that users interact with)
model Contact {
  id         String        @id @default(uuid())
  name       String
  email      String
  phone      String?
  avatarUrl  String?
  externalId String?       // Facebook PSID or other platform-specific user ID
  joined     DateTime      @default(now())
  channel    Channel
  status     ContactStatus @default(new)
  dealName   String?
  price      Float?
  customerId String
  customer   Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  tags          ContactTag[]
  deals         Deal[]
  conversations Conversation[]

  @@unique([customerId, email])
  @@index([externalId, channel])
  @@index([customerId])
}

model ContactTag {
  id        String  @id @default(uuid())
  name      String
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([contactId, name])
}

model Deal {
  id        String     @id @default(uuid())
  name      String
  status    DealStatus @default(InProgress)
  amount    Float
  closeDate DateTime?
  contactId String
  contact   Contact    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([contactId])
}

model Conversation {
  id            String       @id @default(uuid())
  channel       Channel
  unreadCount   Int          @default(0)
  contactId     String
  contact       Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  customerId    String
  customer      Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  integrationId String?
  integration   Integration? @relation(fields: [integrationId], references: [id])
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  messages Message[]

  @@index([contactId])
  @@index([customerId])
  @@index([integrationId])
}

model Message {
  id                String        @id @default(uuid())
  text              String        @db.Text
  sender            MessageSender
  timestamp         DateTime      @default(now())
  externalMessageId String?       // Facebook message ID for deduplication
  conversationId    String
  conversation      Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId            String?
  user              User?         @relation(fields: [userId], references: [id])

  @@index([conversationId])
  @@index([externalMessageId])
}

model Email {
  id         String      @id @default(uuid())
  fromName   String
  fromEmail  String
  fromAvatar String?
  subject    String
  body       String      @db.Text
  timestamp  DateTime    @default(now())
  isRead     Boolean     @default(false)
  folder     EmailFolder @default(inbox)
  userId     String?
  user       User?       @relation("SentEmails", fields: [userId], references: [id])
  customerId String
  customer   Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([folder])
  @@index([customerId])
}

model Integration {
  id                  String            @id @default(uuid())
  name                String
  channel             Channel
  description         String?
  status              IntegrationStatus @default(disconnected)
  apiKey              String?           // Page Access Token for Facebook
  pageId              String?           // Facebook Page ID
  webhookVerified     Boolean           @default(false)
  whatsappPhoneNumber String?
  customerId          String
  customer            Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  userId              String?
  user                User?             @relation(fields: [userId], references: [id])
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  conversations Conversation[]

  @@unique([customerId, channel, userId])
  @@index([customerId])
}

model BusinessInfo {
  id          String   @id @default(uuid())
  companyName String
  address     String?
  phone       String?
  email       String?
  customerId  String   @unique
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model ServiceStatus {
  id          String            @id @default(uuid())
  name        String            @unique
  status      ServiceStatusType @default(operational)
  lastChecked DateTime          @default(now())
}

model UpdateLog {
  id          String   @id @default(uuid())
  version     String
  date        DateTime
  description String
  createdAt   DateTime @default(now())

  changes UpdateLogChange[]
}

model UpdateLogChange {
  id          String    @id @default(uuid())
  change      String
  updateLogId String
  updateLog   UpdateLog @relation(fields: [updateLogId], references: [id], onDelete: Cascade)
}

model SupportMessage {
  id        String               @id @default(uuid())
  text      String               @db.Text
  sender    SupportMessageSender
  timestamp DateTime             @default(now())
  userId    String?
  user      User?                @relation(fields: [userId], references: [id])
}

model FaqItem {
  id       String @id @default(uuid())
  question String
  answer   String @db.Text
  order    Int    @default(0)
}
